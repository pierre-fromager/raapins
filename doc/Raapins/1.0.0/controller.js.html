<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: controller.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: controller.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * controller
 * 
 * is a front rest controller
 */
const restService = require( './service.js');
const ctrlEmitter = require('events').EventEmitter;

const service = new restService();
const controller = new ctrlEmitter();

const qs = require('querystring');
const cors = require('./cors.js');

const hook = {};

/**
 * methods
 * 
 * @returns {Array}
 */
controller.methods = () => {
    return ['get', 'put', 'patch', 'delete', 'post'];
}

/**
 * action
 * 
 * @param {http.request} request
 * @returns {String}
 */
controller.action = (request) => {
    let action = null;
    capitalizeFirstLetter = (string) => {
        return string.charAt(0).toUpperCase() + string.slice(1).toLowerCase();
    }
    if (controller.hook) {
        action = controller.hook.action;
        return action;
    } else {
        action = ((controller.methods().indexOf(request.method.toLowerCase()) !== -1)) 
            ? 'svc' + capitalizeFirstLetter(request.method) 
            : null;
    }
    return action;
}

/**
 * getService
 * 
 * @param {String} service
 * @returns {undefined}
 */
controller.getService = (service) => {}

/**
 * setHook
 * 
 * @param {Object} hook
 * @returns {undefined}
 */
controller.setHook = (hook) => { controller.hook = hook}


/**
 * isHooked
 * 
 * @returns {Boolean}
 */
controller.isHooked = () => {return (controller.hook != null)}

/**
 * listen
 * 
 * @param {controller} controllerInstance
 * @param {router} router
 * @param {http.response} res
 * @param {string} reqRawData
 * @returns {undefined}
 */
controller.listen = (controllerInstance, router, res, reqRawData) => {
    
    controllerInstance.once('data', (data) => {
        res.writeHead(200, cors.getHeaders());
        res.end(JSON.stringify(data));
    });
    
    controllerInstance.once('error', (errorType) => {
        res.writeHead(errorType, cors.getHeaders());
        res.end();
    });
    
    controllerInstance.handle(router, qs.parse(reqRawData));
}

/**
 * sendSignal
 * 
 * @param {string} signal
 * @param {string} response
 * @returns {undefined}
 */
controller.sendSignal = (signal, response) => {
    controller.emit(signal, response);
}

/**
 * handle
 * 
 * @param {router} router
 * @param {array} payload
 * @returns {undefined}
 */
controller.handle = (router, payload ) => {
    let action = controller.action(router.req);
    if(action &amp;&amp; (router.match &amp;&amp; router.match.length > 0)) {
        let apiArguments = [function (apiResponse) {
            if (apiResponse) {
                controller.sendSignal('data', apiResponse);
            } else {
                controller.sendSignal('error', '404');
            }
        }];
        let entityName = (controller.isHooked()) 
            ? controller.hook.params.entityName 
            : router.match[0];
        let id = (router.match[1]) 
            ? (!isNaN(parseInt(router.match[1])) ? router.match[1] : null) 
            : null;
        let params = {
            'entityName' : entityName
            , 'id' : id
            , 'payload' : payload
        };
        apiArguments.push(params);
        let scres = service[action].apply(service, apiArguments);
        controller.setHook(null);
        return;
    } else {
        controller.sendSignal('error', '404');
    }
};

module.exports = controller;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Cors.html">Cors</a></li><li><a href="service.html">service</a></li><li><a href="serviceManager.html">serviceManager</a></li><li><a href="serviceStat.html">serviceStat</a></li></ul><h3>Global</h3><ul><li><a href="global.html#color">color</a></li><li><a href="global.html#dater">dater</a></li><li><a href="global.html#profiler">profiler</a></li><li><a href="global.html#restService">restService</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Mon Jan 23 2017 14:17:59 GMT+0100 (CET)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
